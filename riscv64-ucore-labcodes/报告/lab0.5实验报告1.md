<h1><center>lab0.5å®éªŒæŠ¥å‘Š</center></h1>

<h5><center>ç»„å‘˜ï¼šæœé‘« èƒ¡åšç¨‹ åˆ˜å¿ƒæº</center></h5>

##  ä¸€ã€å®éªŒè¿‡ç¨‹

#### 1ã€ä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨å®Œæˆucoreå†…æ ¸çš„æ˜ åƒæ–‡ä»¶ç”Ÿæˆ

è¿›å…¥lab0æºä»£ç çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`make qemu`æŒ‡ä»¤ï¼Œmakeå·¥å…·å°†è§£æMakefileæ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œäº¤å‰ç¼–è¯‘ã€‚

```makefile
.PHONY: qemu 
qemu: $(UCOREIMG) $(SWAPIMG) $(SFSIMG)
	$(V)$(QEMU) \
		-machine virt \
		-nographic \
		-bios default \
		-device loader,file=$(UCOREIMG),addr=0x80200000

```

`.PHONY`ç”¨äºæŒ‡å®šmakeå·¥å…·çš„ä¼ªç›®æ ‡ï¼Œä¹‹åå¸¦æœ‰$çš„å˜é‡ååœ¨Makefileæ–‡ä»¶ä¸­éƒ½è¢«å®šä¹‰ï¼Œéšååœ¨`$(QEMU)`å‘½ä»¤ä¸‹å¯åŠ¨QEMUè™šæ‹Ÿæœºè®¾ç½®æœºå™¨ç±»å‹ä¸º `virt`ï¼Œä½¿ç”¨äº† `-nographic` é€‰é¡¹ï¼Œæ„å‘³ç€ä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œè€Œæ˜¯åœ¨ç»ˆç«¯ä¸­è¿è¡Œã€‚ä½¿ç”¨ `-bios default` æŒ‡å®šé»˜è®¤çš„ BIOSï¼Œå¹¶ä½¿ç”¨ `-device` é€‰é¡¹åŠ è½½ `$(UCOREIMG)` åˆ°æŒ‡å®šçš„åœ°å€ `0x80200000`ã€‚

å‘½ä»¤æ‰§è¡Œè¿‡åå°†åœ¨ä»£ç æ ¹ç›®å½•ç”Ÿæˆå¤šä¸ªæ–‡ä»¶å¤¹ï¼Œå…¶ä¸­binç›®å½•ä¸‹å«æœ‰ucoreçš„`kernel`å¯æ‰§è¡Œæ–‡ä»¶å’Œæ˜ åƒæ–‡ä»¶ã€‚

#### 2ã€ä½¿ç”¨qemuå’Œgdbè°ƒè¯•æºä»£ç 

ä¸ºäº†ç†Ÿæ‚‰ä½¿ç”¨`qemu`å’Œ`gdb`è¿›è¡Œè°ƒè¯•å·¥ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨`gdb`è°ƒè¯•`qemu`æ¨¡æ‹Ÿçš„RISC-Vè®¡ç®—æœºåŠ ç”µå¼€å§‹è¿è¡Œåˆ°æ‰§è¡Œåº”ç”¨ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼ˆå³è·³è½¬åˆ°`0x80200000`ï¼‰è¿™ä¸ªé˜¶æ®µçš„æ‰§è¡Œè¿‡ç¨‹ã€‚

æˆ‘ä»¬åœ¨ä¸€ä¸ªbashä¸­è¾“å…¥`make debug`ï¼ŒåŒæ—¶æ‰“å¼€å¦ä¸€ä¸ªbashè¾“å…¥`make gdb`å¼€å¯è°ƒè¯•ã€‚

```bash
Reading symbols from bin/kernel...
The target architecture is set to "riscv:rv64".
Remote debugging using localhost:1234
0x0000000000001000 in ?? ()
(gdb) 
```

æ­¤æ—¶æˆ‘ä»¬è¿›å…¥gdbè°ƒè¯•ç•Œé¢ã€‚

è¾“å…¥æŒ‡ä»¤`x/10i $pc`ï¼Œå¯ä»¥æ˜¾ç¤ºå³å°†æ‰§è¡Œçš„10æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚æ³¨æ„åˆ°åœ°å€ä¸º`0x1010`çš„æŒ‡ä»¤æœ‰`jr`ï¼Œå› æ­¤å®é™…ç¨‹åºæ‰§è¡Œåˆ°`0x1010`æ—¶å°±ä¼šè·³è½¬åˆ°`t0`ã€‚

```assembly
(gdb) x/10i $pc
=> 0x1000:      auipc   t0,0x0
   0x1004:      addi    a1,t0,32
   0x1008:      csrr    a0,mhartid
   0x100c:      ld      t0,24(t0)
   0x1010:      jr      t0  #åœ¨æ­¤å¤„ä¼šè·³è½¬åˆ°$t0!
   0x1014:      unimp
   0x1016:      unimp
   0x1018:      unimp
   0x101a:      .2byte  0x8000
   0x101c:      unimp
```

æˆ‘ä»¬ä½¿ç”¨`info r t0`å¯ä»¥æ˜¾ç¤º`t0`å¯„å­˜å™¨çš„å€¼ï¼Œä»è€Œå¾—å‡ºå‰é¢å‡ æ¡æŒ‡ä»¤å®Œæˆçš„åŠŸèƒ½ï¼ˆä¹Ÿå°±æ˜¯ç»ƒä¹ 1çš„è§£ç­”ï¼Œå› æ­¤ç­”æ¡ˆæ”¾åœ¨ä¸‹é¢ï¼‰

ä½¿ç”¨`si`è¿›è¡Œå•æ­¥æ‰§è¡Œï¼Œå¹¶æŸ¥çœ‹æ¶‰åŠåˆ°çš„å¯„å­˜å™¨`t0`çš„ç»“æœï½

```bash
0x0000000000001000 in ?? ()
(gdb) info r t0
t0             0x0      0
(gdb) si       
0x0000000000001004 in ?? ()
(gdb) info r t0
t0             0x1000   4096
(gdb) si
0x0000000000001008 in ?? ()
(gdb) info r t0
t0             0x1000   4096
(gdb) info r a1
a1             0x1020   4128
(gdb) info r a0
a0             0x0      0
(gdb) si
0x000000000000100c in ?? ()
(gdb) info r a0
a0             0x0      0
(gdb) info r mhartid
mhartid        0x0      0
(gdb) si
0x0000000000001010 in ?? ()
(gdb) info r t0
t0             0x80000000       2147483648
(gdb) si
0x0000000080000000 in ?? ()    #æ­¤æ—¶è·³è½¬åˆ°0x800000000
```

å¯ä»¥å‘ç°`mhartid`å¯„å­˜å™¨ä¸­å€¼ä¸º0ï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹idä¸º0

ç¨‹åºåœ¨è·³è½¬åˆ°åœ°å€`0x80000000`ä¹‹åç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªåœ°å€å¤„åŠ è½½`QEMU`è‡ªå¸¦çš„bootloader`OpenSBI.bin`ï¼Œå¯åŠ¨OpenSBIå›ºä»¶ã€‚(æ ¹æ®å®éªŒæŒ‡å¯¼ä¹¦)

> Qemu å¼€å§‹æ‰§è¡Œä»»ä½•æŒ‡ä»¤ä¹‹å‰ï¼Œé¦–å…ˆä¸¤ä¸ªæ–‡ä»¶å°†è¢«åŠ è½½åˆ° Qemu çš„ç‰©ç†å†…å­˜ä¸­ï¼šå³ä½œä¸º bootloader çš„ OpenSBI.bin è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä»¥ç‰©ç†åœ°å€ 0x80000000 å¼€å¤´çš„åŒºåŸŸä¸Šï¼ŒåŒæ—¶å†…æ ¸é•œåƒ os.bin è¢«åŠ è½½åˆ°ä»¥ç‰©ç†åœ°å€ 0x80200000 å¼€å¤´çš„åŒºåŸŸä¸Š

```assembly
=> 0x80000000:  csrr    a6,mhartid
   0x80000004:  bgtz    a6,0x80000108
   0x80000008:  auipc   t0,0x0
   0x8000000c:  addi    t0,t0,1032
   0x80000010:  auipc   t1,0x0
   0x80000014:  addi    t1,t1,-16
   0x80000018:  sd      t1,0(t0)
   0x8000001c:  auipc   t0,0x0
   0x80000020:  addi    t0,t0,1020
   0x80000024:  ld      t0,0(t0)
```

`csrr a6,mhartid`:ä» `mhartid` (hardware thread ID) æ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨ (CSR) è¯»å–å½“å‰ç¡¬ä»¶çº¿ç¨‹çš„ ID å¹¶å°†å…¶å­˜å‚¨åˆ°å¯„å­˜å™¨ `a6` ä¸­ã€‚

`bgtz a6,0x80000108`ï¼šå¦‚æœ `a6` çš„å€¼å¤§äºé›¶ï¼Œåˆ™è·³è½¬åˆ°åœ°å€ `0x80000108`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç¡®ä¿åªæœ‰ä¸»æ ¸ï¼ˆæ ¸å¿ƒIDä¸º0ï¼‰æ‰§è¡Œåç»­çš„åˆå§‹åŒ–ä»£ç ã€‚

åé¢çš„æ±‡ç¼–ä»£ç æ¶‰åŠå†…å­˜å’Œå¯„å­˜å™¨åˆå§‹åŒ–çš„è¿‡ç¨‹

æ¥ä¸‹æ¥è¾“å…¥æŒ‡ä»¤`break *0x802000000`ï¼Œbashè¾“å‡ºå¦‚ä¸‹ï¼š

```assembly
(gdb) break *0x80200000
Breakpoint 1 at 0x80200000: file kern/init/entry.S, line 7.
```

æ³¨æ„åˆ°`0x80200000`æ˜¯`kernel.ld`ä¸­å®šä¹‰çš„`BASE_ADDRESS`ï¼ˆåŠ è½½åœ°å€ï¼‰æ‰€å†³å®šçš„ï¼ŒåŒæ—¶åœ¨`kernel.ld`ä¸­ä¹Ÿå®šä¹‰äº†å…¥å£ç‚¹ENTRY`kern_entry`ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬è¾“å…¥`break kern_entry`ï¼Œä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„ç»“æœã€‚

```assembly
(gdb) break kern_entry
Note: breakpoint 1 also set at pc 0x80200000.
Breakpoint 2 at 0x80200000: file kern/init/entry.S, line 7.
```

æ‰“å¼€`entry.S`ï¼Œè§‚å¯Ÿç›¸åº”çš„ä»£ç 

```assembly
    .section .text,"ax",%progbits
    .globl kern_entry 
kern_entry:
    la sp, bootstacktop
    tail kern_init
```

`kern_entry`æ ‡ç­¾å¯¹åº”çš„æ±‡ç¼–ä»£ç æœ‰ä¸¤å¥ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š

- `la sp, bootstacktop`ï¼šåŠ è½½`bootstacktop`çš„åœ°å€åˆ°æ ˆæŒ‡é’ˆå¯„å­˜å™¨`sp`ï¼Œä»è€Œè®¾ç½®æ ˆé¡¶ï¼›
- `tail kern_init`ï¼šå°¾è°ƒç”¨å‡½æ•°`kern_init`ï¼Œå°¾è°ƒç”¨ç›´æ¥è·³è½¬åˆ°ç›®æ ‡å‡½æ•°ï¼Œæ„å‘³ç€**å½“å‰å‡½æ•°çš„æ ˆå¸§å°†è¢«æ–°è°ƒç”¨çš„å‡½æ•°é‡ç”¨**ã€‚

è¾“å…¥`x/10i 0x80200000`ï¼ŒæŸ¥çœ‹æ¥ä¸‹æ¥çš„æ±‡ç¼–ä»£ç ï¼š
```assembly
(gdb) x/10i 0x80200000
=> 0x80200000 <kern_entry>:	    auipc	sp,0x3
   0x80200004 <kern_entry+4>:	mv	    sp,sp
   0x80200008 <kern_entry+8>:	j	    0x8020000c <kern_init>
   0x8020000c <kern_init>:	    auipc	a0,0x3
   0x80200010 <kern_init+4>:	addi	a0,a0,-4
   0x80200014 <kern_init+8>:	auipc	a2,0x3
   0x80200018 <kern_init+12>:	addi	a2,a2,-12
   0x8020001c <kern_init+16>:	addi	sp,sp,-16
   0x8020001e <kern_init+18>:	li	    a1,0
   0x80200020 <kern_init+20>:	sub		a2,a2,a0
```

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨`kern_entry`ä¹‹åç´§æ¥ç€å°±æ˜¯`kern_init`ç¬¦åˆæˆ‘ä»¬åˆšæŸ¥çœ‹çš„`entry.S`ã€‚

è¾“å…¥`continue`è¿è¡Œåˆ°`0x80200000`å¤„ï¼Œæˆ‘ä»¬å‘ç°`make debug`çš„çª—å£æœ‰æ–°è¾“å‡ºå¦‚ä¸‹ï¼š

```bash
OpenSBI v0.4 (Jul  2 2019 11:53:53)
   ____                    _____ ____ _____
  / __ \                  / ____|  _ \_   _|
 | |  | |_ __   ___ _ __ | (___ | |_) || |
 | |  | | '_ \ / _ \ '_ \ \___ \|  _ < | |
 | |__| | |_) |  __/ | | |____) | |_) || |_
  \____/| .__/ \___|_| |_|_____/|____/_____|
        | |
        |_|

Platform Name          : QEMU Virt Machine
Platform HART Features : RV64ACDFIMSU
Platform Max HARTs     : 8
Current Hart           : 0
Firmware Base          : 0x80000000
Firmware Size          : 112 KB
Runtime SBI Version    : 0.1

PMP0: 0x0000000080000000-0x000000008001ffff (A)
PMP1: 0x0000000000000000-0xffffffffffffffff (A,R,W,X)
```

è¯æ˜OpenSBIæ­¤æ—¶å·²ç»å¯åŠ¨ã€‚

è¾“å…¥æŒ‡ä»¤`break kern_init`ï¼Œå¾—åˆ°è¾“å‡ºï¼š

```assembly
(gdb) break kern_init
Breakpoint 3 at 0x8020000c: file kern/init/init.c, line 8. 
```

è¿™é‡Œå°±æŒ‡å‘äº†ä¹‹å‰æ˜¾ç¤ºä¸º`<kern_init>`çš„åœ°å€`0x802000c` 

ç»§ç»­`continue`ï¼Œç„¶åè¾“å…¥`disassemble kern_init`æŸ¥çœ‹`kern_init`å¯¹åº”çš„RISC-Vä»£ç 

```assembly
Dump of assembler code for function kern_init:
=> 0x000000008020000c <+0>:	    auipc	a0,0x3
   0x0000000080200010 <+4>:		addi	a0,a0,-4 # 0x80203008
   0x0000000080200014 <+8>:		auipc	a2,0x3
   0x0000000080200018 <+12>:	addi	a2,a2,-12 # 0x80203008
   0x000000008020001c <+16>:	addi	sp,sp,-16
   0x000000008020001e <+18>:	li		a1,0
   0x0000000080200020 <+20>:	sub		a2,a2,a0
   0x0000000080200022 <+22>:	sd		ra,8(sp)
   0x0000000080200024 <+24>:	jal		ra,0x802004ce <memset>
   0x0000000080200028 <+28>:	auipc	a1,0x0
   0x000000008020002c <+32>:	addi	a1,a1,1208 # 0x802004e0
   0x0000000080200030 <+36>:	auipc	a0,0x0
   0x0000000080200034 <+40>:	addi	a0,a0,1232 # 0x80200500
   0x0000000080200038 <+44>:	jal		ra,0x80200058 <cprintf>
   0x000000008020003c <+48>:	j		0x8020003c <kern_init+48>
End of assembler dump.
```

è§‚å¯Ÿå‘ç°è¿™ä¸ªå‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤`0x000000008020003c <+48>:    j       0x8020003c <kern_init+48>`æ˜¯è·³è½¬åˆ°è‡ªå·±å¼€å§‹çš„åœ°å€ï¼Œæ‰€ä»¥ä»£ç å°†ä¼šä¸€ç›´å¾ªç¯ä¸‹å»ã€‚

ç»§ç»­`continue`ï¼Œè§‚å¯Ÿdebugçš„çª—å£ï¼Œå‘ç°æœ‰æ–°è¾“å‡ºï¼š

```bash
(NKU.CST) os is loading ...   #æ²¡ä»€ä¹ˆåˆ«çš„æ„æ€ï¼Œå°±æ˜¯æŠŠTHUæ”¹æˆäº†NKUï¼Œçœ‹ä¸é¡ºçœ¼ğŸ˜
```

æœ¬æ¬¡å®éªŒè¿‡ç¨‹å®Œç»“æ’’èŠ±ï½ğŸ‰



## äºŒã€ç»ƒä¹ 1é—®é¢˜

#### **Q1:RISC-Vç¡¬ä»¶åŠ ç”µåçš„å‡ æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ**

A1:åœ¨åœ°å€`0x1000`åˆ°åœ°å€`0x1010`ã€‚



#### **Q2:å®Œæˆäº†å“ªäº›åŠŸèƒ½ï¼Ÿ**

æ ¹æ®å¯„å­˜å™¨ç»“æœä»¥åŠå¯¹RISC-Væ±‡ç¼–è¯­è¨€çš„éƒ¨åˆ†æŸ¥é˜…ï¼Œå¾—åˆ°æ¯ä¸€æ¡æŒ‡ä»¤æ‰€å®ŒæˆåŠŸèƒ½ï¼š

- `auipc t0,0x0`ï¼š`auipc`æ˜¯æŠŠç«‹å³æ•°åŠ åˆ°PCä¸Šã€‚è¯¥æŒ‡ä»¤**å°†ç«‹å³æ•°`0x0`å·¦ç§»20ä½å¹¶æ·»åŠ åˆ°ç¨‹åºè®¡æ•°å™¨**ï¼ˆPCï¼‰çš„å½“å‰å€¼ä¸Šã€‚å°†è¿™ä¸ªç»“æœå­˜å‚¨åˆ°`t0`å¯„å­˜å™¨ä¸­ã€‚æ­¤æ—¶`t0`ä¸­åœ°å€ä¸º`0x1000`ï¼›

- `addi a1,t0,32`ï¼šå°†ç«‹å³æ•°`32`åŠ åˆ°`t0`ä¸Šï¼Œå¹¶æŠŠè¿™ä¸ªç»“æœå­˜å‚¨åœ¨`a1`ã€‚æ­¤æ—¶`a1`çš„åœ°å€ä¸º`0x20`ï¼›

  P.s.`auipc`å°†ç«‹å³æ•°å·¦ç§»20ä½å¹¶æ·»åŠ åˆ°ç¨‹åºè®¡æ•°å™¨ä¸Šï¼Œè¿™é‡Œæ¶‰åŠåˆ°RISC-V æŒ‡ä»¤é›†åŠ è½½å¤šä½æ•°ï¼ˆå¦‚32ä½ï¼‰åœ°å€è¿›å…¥å¯„å­˜å™¨çš„æ“ä½œï¼Œç”±äºRISC-VæŒ‡ä»¤å‡ä¸º32ä½ï¼Œä¸å¯èƒ½ç”¨32ä½å…¨éƒ¨è¡¨ç¤ºä¸€ä¸ªç«‹å³æ•°ï¼ˆauipcå’ŒluiæŒ‡ä»¤å‡åªæœ‰20ä½è¡¨ç¤ºç«‹å³æ•°ï¼‰æ‰€ä»¥æˆ‘ä»¬æƒ³å¾€å¯„å­˜å™¨è½½å…¥32ä½åœ°å€ä¸èƒ½åªé€šè¿‡ä¸€æ¡æŒ‡ä»¤ï¼Œè€Œæ˜¯åˆ†ä¸¤æ¡æŒ‡ä»¤åˆ†åˆ«åŠ è½½åœ°å€çš„é«˜ä½å’Œä½ä½ï¼ˆ`auipc`æŒ‡ä»¤ç”¨äºåŠ è½½é«˜ä½ï¼Œ`addi`æŒ‡ä»¤ç”¨äºåŠ è½½ä½ä½ï¼‰

- `csrr a0,mhartid`ï¼šè¯»å–çŠ¶æ€å¯„å­˜å™¨`mhartid`ï¼Œå­˜å‚¨åˆ°`a0`ä¸­ã€‚`mhartid`ä¸ºå½“å‰ç¡¬ä»¶çº¿ç¨‹çš„IDï¼›

- `ld t0,24(t0)`ï¼š`ld`æ˜¯ä»å†…å­˜ä¸­åŠ è½½ä¸€ä¸ªåŒå­—ï¼ˆ64ä½å€¼ï¼‰ï¼Œè¿™é‡Œå®ƒä»`t0+24`åœ°å€å¤„è¯»å–ä¸€ä¸ªåŒå­—ï¼ˆ8å­—èŠ‚ï¼‰ï¼Œå­˜åˆ°`t0`ï¼›

- `jr t0`ï¼šå¯„å­˜å™¨è·³è½¬ï¼Œè·³è½¬åˆ°`t0`æŒ‡å‘çš„åœ°å€å¤„ï¼Œè¿™é‡Œä¸º`0x80000000`ã€‚ç„¶åå¼€å§‹åŠ è½½bootloaderã€‚æ­¤æ—¶RISC-Vç¡¬ä»¶åŠ ç”µæ“ä½œå®Œæˆã€‚





## ä¸‰ã€æœ¬å®éªŒé‡è¦çŸ¥è¯†ç‚¹

#### Qemuå¯åŠ¨æµç¨‹

åŠ ç”µ -> OpenSBI å¯åŠ¨ -> è·³è½¬åˆ° 0x80200000 (kern/init/entry.Sï¼‰-> è¿›å…¥ kern_init() å‡½æ•°ï¼ˆkern/

init/init.c) -> è°ƒç”¨ cprintf() è¾“å‡ºä¸€è¡Œä¿¡æ¯-> ç»“æŸ

#### Makefile

makeå·¥å…·å¯ä»¥ä¾ç…§Makefileæ–‡ä»¶ä¸­çš„å†…å®¹è‡ªåŠ¨ç¼–è¯‘å’Œé“¾æ¥ç¨‹åºï¼ŒåŸºæœ¬è§„åˆ™ä¸º

```makefile
target: dependencies
	commands
```

ç›®æ ‡å³è¦ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¾èµ–å³ç›®æ ‡æ–‡ä»¶ç”±å“ªäº›æ–‡ä»¶ç”Ÿæˆï¼Œå‘½ä»¤å³é€šè¿‡æ‰§è¡Œå‘½ä»¤ç”±ä¾èµ–æ–‡ä»¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚æ³¨æ„æ¯æ¡å‘½ä»¤ä¹‹å‰å¿…é¡»æœ‰ä¸€ä¸ªtabä¿æŒç¼©è¿›

Makefileä¸­çš„å˜é‡è§„åˆ™ï¼š

- $ç¬¦å·è¡¨ç¤ºå–å˜é‡çš„å€¼ï¼Œå½“å˜é‡åå¤šäºä¸€ä¸ªå­—ç¬¦æ—¶ï¼Œä½¿ç”¨"( )"ï¼Œå®šä¹‰å˜é‡å¯ä»¥åœ¨Makefileå¼€å¤´ç›´æ¥ç”¨å­—ç¬¦ä¸²ä½œä¸ºå˜é‡å
- **`$@`**: ç›®æ ‡æ–‡ä»¶åï¼Œè¿™ä¸ªå˜é‡ä»£è¡¨è§„åˆ™ä¸­çš„ç›®æ ‡åç§°ã€‚
- **`$<`**: ç¬¬ä¸€ä¸ªä¾èµ–é¡¹ï¼Œè¿™ä¸ªå˜é‡ä»£è¡¨è§„åˆ™ä¸­çš„ç¬¬ä¸€ä¸ªä¾èµ–ã€‚
- **`$^`**: æ‰€æœ‰çš„ä¾èµ–é¡¹ï¼Œåˆ—è¡¨å½¢å¼
- **`$\*`**: å½“å‰ç›®æ ‡çš„å‰ç¼€

å¯¹äºä¼ªç›®æ ‡ï¼ˆåªæ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼‰ï¼Œç”¨makeè°ƒç”¨çš„æ—¶å€™æ‰§è¡Œï¼Œä½¿ç”¨ä¼ªç›®æ ‡æ˜¯ä¸ºäº†è§£å†³ç›®å½•ä¸‹æœ‰ä¸make å‘½ä»¤åŒåçš„æ–‡ä»¶çš„æƒ…å†µï¼Œä½¿ç”¨.PHONYå…³é”®å­—ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª`make clean`å‘½ä»¤çš„å®ç°æ–¹å¼ï¼Œç”¨äºåˆ é™¤å½“å‰ç›®å½•ä¸­æ‰€æœ‰çš„ `.o` æ–‡ä»¶ï¼Œæ¸…ç†ç¼–è¯‘åç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ã€‚

```makefile
.PHONY: clean
clean:
	rm -f *.o
```

#### bootloader

è´Ÿè´£è´Ÿè´£åˆå§‹åŒ–ç¡¬ä»¶å¹¶æŠŠæ“ä½œç³»ç»ŸåŠ è½½åˆ°å†…å­˜é‡Œï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨çš„QEMU è‡ªå¸¦çš„ bootloader: OpenSBI å›ºä»¶ï¼ŒOpenSBI å°†æ‰¾åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„å­˜å‚¨ä½ç½®ï¼Œå¹¶å°†å…¶åŠ å…¥å†…å­˜ï¼Œå°†PCæŒ‡å‘å†…æ ¸çš„åˆå§‹åŒ–éƒ¨åˆ†ï¼Œæ‰§è¡Œæ“ä½œç³»ç»Ÿæºä»£ç ã€‚

æœ¬æ¬¡å®éªŒä¸­ï¼Œä½œä¸º bootloader çš„ OpenSBI.bin è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä»¥ç‰©ç†åœ°å€ 0x80000000 å¼€å¤´çš„åŒºåŸŸä¸Šï¼ŒåŒæ—¶å†…æ ¸é•œåƒ os.bin è¢«åŠ è½½åˆ°ä»¥ç‰©ç†åœ°å€ 0x80200000 å¼€å¤´çš„åŒºåŸŸä¸Šã€‚

P.s. **å›ºä»¶** æ˜¯ä¸€ç§ç‰¹å®šçš„è®¡ç®—æœºè½¯ä»¶ï¼Œä»–å¯ä»¥ä¸ºè®¾å¤‡æ›´å¤æ‚çš„è½¯ä»¶ï¼ˆå¦‚æ“ä½œç³»ç»Ÿï¼‰æä¾›æ ‡å‡†åŒ–çš„æ“ä½œç¯å¢ƒï¼Œç”šè‡³ç›´æ¥ä½œä¸ºæ“ä½œç³»ç»Ÿï¼Œæ‰§è¡Œæ§åˆ¶ã€ç›‘è§†å’Œæ•°æ®æ“ä½œåŠŸèƒ½ã€‚

#### å¤ä½åœ°å€

æŒ‡çš„æ˜¯ CPU åœ¨ä¸Šç”µçš„æ—¶å€™ï¼Œæˆ–è€…æŒ‰ä¸‹å¤ä½é”®çš„æ—¶å€™ï¼ŒPC è¢«èµ‹çš„åˆå§‹å€¼ã€‚æœ¬å®éªŒä¸­ï¼ŒQEMU æ¨¡æ‹Ÿçš„riscv å¤„ç†å™¨å¤ä½åœ°å€ä¸º`0x1000`ï¼ˆæˆ‘ä»¬ä¹Ÿåœ¨ç¨‹åºå¼€å§‹åæ¡æ±‡ç¼–æŒ‡ä»¤å¤„éªŒè¯äº†è¿™ä¸ªåœ°å€ï¼‰ï¼Œå¤„ç†å™¨å°†ä»æ­¤å¤„å¼€å§‹æ‰§è¡Œå¤ä½ä»£ç ï¼Œå°†ä¼šåˆå§‹åŒ–CPUã€å†…å­˜å’Œå¤–è®¾ï¼Œä¹‹åå¯åŠ¨boostloaderï¼ŒåŠ è½½æ“ä½œç³»ç»Ÿå†…æ ¸å¹¶å°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿã€‚



## å››ã€æœ¬å®éªŒä¸­é‡åˆ°çš„é—®é¢˜

#### ç¯å¢ƒå˜é‡å‘½åå†²çª

åœ¨è®¾å®šå·¥å…·é“¾ç¯å¢ƒå˜é‡çš„æ—¶å€™ï¼Œä½¿ç”¨äº†ä¸‹é¢çš„å‘½ä»¤

```bash
export QEMU=/home/ffang/riscv/qemu-4.1.1
export PATH=$QEMU/riscv32-softmmu:$QEMU/riscv64-softmmu:$PATH

export UCOREIMG=/home/ffang/riscv/labcodes/lab0/bin/ucore.img
export PATH=$UCOREIMG:$PATH
```

è¿™ä¸Makefileæ–‡æ¡£ä¸­çš„è®¾å®šå†²çªï¼Œå¯¼è‡´äº†ç¼–è¯‘ä½¿ç”¨çš„å‘½ä»¤å˜æˆäº†`/home/ffang/riscv/qemu-4.1.1`ä½†å…¶å®åº”è¯¥æ˜¯`qemu-system-riscv64`

ä¸‹é¢ä»£ç çš„æ„ä¹‰æ˜¯å¦‚æœQEMUè¿™ä¸ªå˜é‡æ²¡æœ‰å®šä¹‰åˆ™å¢åŠ QEMUä½œä¸ºç¯å¢ƒå˜é‡ï¼Œä¸”å–å€¼ä¸º`qemu-system-riscv64`

```makefile
#ifndef GCCPREFIX
GCCPREFIX := riscv64-unknown-elf-
#endif

ifndef QEMU
QEMU := qemu-system-riscv64
endif
```

ä»è€Œå¯¼è‡´æŠ¥é”™ï¼š`make: home/ffang/riscv/qemu-4.1.1: æƒé™ä¸å¤Ÿ`

ä¿®æ”¹ç¯å¢ƒå˜é‡å‘½åï¼Œåˆ·æ–°ç¯å¢ƒå˜é‡ï¼ŒæŠ¥é”™è§£é™¤

```bash
export MYQEMU=/home/ffang/riscv/qemu-4.1.1
export PATH=$MYQEMU/riscv32-softmmu:$MYQEMU/riscv64-softmmu:$PATH

export MYUCOREIMG=/home/ffang/riscv/labcodes/lab0/bin/ucore.img
export PATH=$MYUCOREIMG:$PATH
```



#### æŒ‡ä»¤å‡ºç°åŠå­—æŒ‡ä»¤

æœ‰æ—¶åœ¨`kern_entry`å…¥å£å¤„çš„åæ¡æ±‡ç¼–è¯­å¥è¿™é‡Œä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå‘ç°`j       0x8020000a <kern_init>`å’Œ` auipc   a0,0x3`ä¹‹é—´æŒ‡ä»¤å‡ºç°äº†16ä½çš„å·®è·ï¼Œä½†RISCVæŒ‡ä»¤é›†çš„æŒ‡ä»¤åº”è¯¥æ˜¯è§„æ•´çš„32ä½ï¼Œä¸è¿‡ä¸ºäº†æé«˜ä»£ç å¯†åº¦ï¼ŒRISC-V å¼•å…¥äº†ä¸€ä¸ªå«åš "Compressed" çš„å¯é€‰æ‰©å±•ï¼Œè¯¥æ‰©å±•ä¸ºå¸¸ç”¨çš„æ“ä½œæä¾›äº† 16 ä½ç‰ˆæœ¬çš„æŒ‡ä»¤ï¼Œç›®çš„æ˜¯å‡å°‘ç¨‹åºå’Œå¸¸ç”¨æ“ä½œçš„å¤§å°ï¼Œä»è€Œåœ¨å­˜å‚¨å’Œå†…å­˜å¸¦å®½ä¸ŠèŠ‚çœç©ºé—´ã€‚

```bash
(gdb) x/10i 0x80200000
=> 0x80200000 <kern_entry>:     auipc   sp,0x3
   0x80200004 <kern_entry+4>:   mv      sp,sp
   0x80200008 <kern_entry+8>:   j       0x8020000a <kern_init>
   0x8020000a <kern_init>:      auipc   a0,0x3
   0x8020000e <kern_init+4>:    addi    a0,a0,-2
   0x80200012 <kern_init+8>:    auipc   a2,0x3
   0x80200016 <kern_init+12>:   addi    a2,a2,-10
   0x8020001a <kern_init+16>:   addi    sp,sp,-16
   0x8020001c <kern_init+18>:   li      a1,0
   0x8020001e <kern_init+20>:   sub     a2,a2,a0
```

ä½¿ç”¨å‘½ä»¤`qemu-system-riscv64 -cpu help`æŸ¥çœ‹è¯¥ç‰ˆæœ¬QEMUæ”¯æŒçš„RISCVå¤„ç†å™¨ç±»å‹ï¼Œå‘ç°æœ‰å«â€˜câ€™ï¼ˆå³æ”¯æŒæŒ‡ä»¤å‹ç¼©æ‹“å±•çš„å¤„ç†å™¨ï¼‰

```bash
any
rv64
rv64gcsu-v1.10.0
rv64gcsu-v1.9.1
rv64imacu-nommu
sifive-e51
sifive-u54
```

